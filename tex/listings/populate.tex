\begin{lstlisting}[language=SQL]
SET search_path = notion_dw;

-- ==========================================================
-- (1) Ensure partitions for 2024-01 .. 2025-12 (monthly)
--     Required because fact_product_usage_engagement is PARTITION BY RANGE(time_key)
-- ==========================================================
DO $$
DECLARE
  m_start DATE;
  m_end   DATE;
  p_from  INT;
  p_to    INT;
  p_name  TEXT;
BEGIN
  m_start := DATE '2024-01-01';

  WHILE m_start <= DATE '2025-12-01' LOOP
    m_end := (m_start + INTERVAL '1 month')::DATE;

    p_from := (EXTRACT(YEAR FROM m_start)::INT * 10000
               + EXTRACT(MONTH FROM m_start)::INT * 100
               + EXTRACT(DAY FROM m_start)::INT);

    p_to := (EXTRACT(YEAR FROM m_end)::INT * 10000
             + EXTRACT(MONTH FROM m_end)::INT * 100
             + EXTRACT(DAY FROM m_end)::INT);

    p_name := format('fact_p_%s', to_char(m_start, 'YYYYMM'));

    EXECUTE format(
      'CREATE TABLE IF NOT EXISTS %I PARTITION OF fact_product_usage_engagement FOR VALUES FROM (%s) TO (%s);',
      p_name, p_from, p_to
    );

    m_start := m_end;
  END LOOP;
END $$;

-- ==========================================================
-- (2) TIME DIMENSION: 2024-01-01 .. 2025-12-31
-- ==========================================================
INSERT INTO dim_time (
  time_key, calendar_date, day_of_week, is_weekend,
  week_of_year, month, quarter, year, day_since_signup_bucket
)
SELECT
  (EXTRACT(YEAR FROM d)::INT * 10000
   + EXTRACT(MONTH FROM d)::INT * 100
   + EXTRACT(DAY FROM d)::INT) AS time_key,
  d::DATE AS calendar_date,
  EXTRACT(ISODOW FROM d)::SMALLINT AS day_of_week,
  (EXTRACT(ISODOW FROM d) IN (6,7)) AS is_weekend,
  EXTRACT(WEEK FROM d)::SMALLINT AS week_of_year,
  EXTRACT(MONTH FROM d)::SMALLINT AS month,
   EXTRACT(QUARTER FROM d)::SMALLINT AS quarter,
   EXTRACT(YEAR FROM d)::SMALLINT AS year,
   NULL::SMALLINT AS day_since_signup_bucket
FROM generate_series(DATE '2024-01-01', DATE '2025-12-31', INTERVAL '1 day') AS g(d)
ON CONFLICT (time_key) DO NOTHING;

-- ==========================================================
-- (3) DEVICE DIMENSION: small fixed set
-- ==========================================================
INSERT INTO dim_device (device_id_nat, platform, operating_system, app_version, device_form_factor)
VALUES
  ('dev_web_win', 'web',     'Windows', '3.08.0', 'desktop'),
  ('dev_web_mac', 'web',     'macOS',   '3.08.1', 'desktop'),
  ('dev_desktop', 'desktop', 'macOS',   '3.09.0', 'desktop'),
  ('dev_ios',     'mobile',  'iOS',     '3.07.9', 'phone'),
  ('dev_android', 'mobile',  'Android', '3.08.2', 'phone')
ON CONFLICT (device_id_nat) DO NOTHING;

-- ==========================================================
-- (4) CONTENT DIMENSION: small fixed set
-- ==========================================================
INSERT INTO dim_content (content_id_nat, content_type, is_template_based, is_shared, ownership_type)
VALUES
  ('cnt_page',      'page',       FALSE, FALSE, 'personal'),
  ('cnt_database',  'database',   TRUE,  TRUE,  'workspace'),
  ('cnt_wiki',      'wiki',       TRUE,  TRUE,  'team_space'),
  ('cnt_taskboard', 'task_board', FALSE, TRUE,  'workspace'),
  ('cnt_template',  'page',       TRUE,  FALSE, 'personal')
ON CONFLICT (content_id_nat) DO NOTHING;

-- ==========================================================
-- (5) EVENT DIMENSION: small fixed set
-- ==========================================================
INSERT INTO dim_event (event_type, feature_category, interaction_intent)
VALUES
  ('view',         'Core',          'consumption'),
  ('create',       'Core',          'creation'),
  ('edit',         'Core',          'creation'),
  ('comment',      'Collaboration', 'collaboration'),
  ('share',        'Collaboration', 'collaboration'),
  ('db_query',     'Databases',     'consumption'),
  ('api_call',     'Integrations',  'creation'),
  ('template_use', 'Templates',     'creation')
ON CONFLICT (event_type, feature_category, interaction_intent) DO NOTHING;

-- ==========================================================
-- (6) USER DIMENSION: monthly cohorts (480 users)
--     - 20 users per month from Jan 2024 through Dec 2025 (24 months).
--     - Tier mix spread evenly; lifecycle varied.
-- ==========================================================
INSERT INTO dim_user (
  user_id_nat, username, signup_date, subscription_tier,
  user_type, region, lifecycle_stage
)
SELECT
  'usr_' || LPAD(i::TEXT, 4, '0') AS user_id_nat,
  'user_' || LPAD(i::TEXT, 4, '0') AS username,
  (DATE '2024-01-05'
   + (((i-1) / 20) * INTERVAL '1 month')
   + ((i-1) % 20) * INTERVAL '1 day')::date AS signup_date,
  (ARRAY['Free','Plus','Business','Enterprise'])[(i % 4) + 1] AS subscription_tier,
  (ARRAY['individual','member','guest'])[(i % 3) + 1] AS user_type,
  (ARRAY['EU','NA','APAC'])[(i % 3) + 1] AS region,
  (ARRAY['onboarding','active','active','dormant'])[(i % 4) + 1] AS lifecycle_stage
FROM generate_series(1,480) i
ON CONFLICT (user_id_nat) DO NOTHING;

-- ==========================================================
-- (7) WORKSPACE DIMENSION: >= 50 workspaces
-- ==========================================================
INSERT INTO dim_workspace (
  workspace_id_nat, workspace_plan,
  workspace_size_bucket, industry_segment, workspace_region
)
SELECT
  'ws_' || LPAD(i::TEXT, 3, '0') AS workspace_id_nat,
  (ARRAY['Free','Plus','Business','Enterprise'])[1 + (random()*3)::INT] AS workspace_plan,
  (ARRAY['1','2--10','11--50','50+'])[1 + (random()*3)::INT] AS workspace_size_bucket,
  (ARRAY['Education','Software','Finance','Consulting'])[1 + (random()*3)::INT] AS industry_segment,
  (ARRAY['EU','NA'])[1 + (random())::INT] AS workspace_region
FROM generate_series(1,50) i
ON CONFLICT (workspace_id_nat) DO NOTHING;

-- ==========================================================
-- (8) SESSION DIMENSION: dense coverage (5 sessions per day)
--     - session_start_time within 2024-01-01 .. 2025-12-31
--     - duration 20..70 minutes
-- ==========================================================
INSERT INTO dim_session (
  session_id_nat, session_start_time, session_end_time, session_origin
)
SELECT
  'sess_' || LPAD(i::TEXT, 5, '0') AS session_id_nat,
  ts AS session_start_time,
  LEAST(
    ts + ((1200 + random()*3000)::INT || ' seconds')::INTERVAL,
    TIMESTAMP '2025-12-31 23:59:59'
  ) AS session_end_time,
  (ARRAY['direct','link','notification'])[1 + (random()*2)::INT] AS session_origin
FROM (
  SELECT
    i,
    (TIMESTAMP '2024-01-01'
     + ((i / 5)::INT || ' days')::INTERVAL  -- walk the calendar
     + (random() * INTERVAL '12 hours')) AS ts
  FROM generate_series(0, (731*5)) i  -- ~5 sessions per day across full range
) s
ON CONFLICT (session_id_nat) DO NOTHING;

-- ==========================================================
-- (9) FACT TABLE: Structured activity (activation + ongoing engagement)
--     - Activation events: up to 2 per activating user within 7 days of signup.
--     - Ongoing events: tier-weighted monthly volume with content/device bias.
-- ==========================================================
WITH months AS (
  SELECT date_trunc('month', d)::date AS month_start
  FROM generate_series(DATE '2024-01-01', DATE '2025-12-01', INTERVAL '1 month') d
),
month_spans AS (
  SELECT
    month_start,
    (month_start + INTERVAL '1 month' - INTERVAL '1 day')::date AS month_end
  FROM months
),
user_profile AS (
  SELECT
    u.user_key,
    u.signup_date,
    u.subscription_tier,
    CASE u.subscription_tier
      WHEN 'Free'       THEN 6
      WHEN 'Plus'       THEN 10
      WHEN 'Business'   THEN 16
      ELSE                 20
    END AS monthly_base,
    CASE u.subscription_tier
      WHEN 'Free'       THEN 0.25
      WHEN 'Plus'       THEN 0.40
      WHEN 'Business'   THEN 0.55
      ELSE                 0.70
    END AS activation_prob,
    -- deterministic activation choice per user based on md5(user_id_nat)
    (
      (('x' || substr(md5(u.user_id_nat), 1, 8))::bit(32)::int % 100)::numeric / 100.0
      < CASE u.subscription_tier
          WHEN 'Free'       THEN 0.25
          WHEN 'Plus'       THEN 0.40
          WHEN 'Business'   THEN 0.55
          ELSE                 0.70
        END
    ) AS activates
  FROM dim_user u
),
activation_events AS (
  SELECT
    up.user_key,
    GREATEST(up.signup_date, DATE '2024-01-01') + (g-1) AS event_date,
    'activation'::TEXT AS stage
  FROM user_profile up
  CROSS JOIN generate_series(1,2) g
  WHERE up.activates
    AND up.signup_date + (g-1) <= DATE '2025-12-31'
),
recurring_volume AS (
  SELECT
    up.user_key,
    up.signup_date,
    up.subscription_tier,
    ms.month_start,
    ms.month_end,
    up.monthly_base
      + (CASE WHEN up.subscription_tier IN ('Business','Enterprise') THEN 6 ELSE 0 END)
      + (random()*4)::INT  AS monthly_events
  FROM user_profile up
  JOIN month_spans ms
    ON ms.month_start >= date_trunc('month', up.signup_date)
   AND ms.month_start <= DATE '2025-12-01'
),
recurring_events AS (
  SELECT
    rv.user_key,
    rv.subscription_tier,
    rv.signup_date,
    rv.month_start,
    rv.month_end,
    rv.monthly_events,
    generate_series(1, rv.monthly_events) AS idx
  FROM recurring_volume rv
),
event_pool AS (
  -- Merge activation and ongoing events into one set with event_date and attributes.
  SELECT
    e.user_key,
    GREATEST(e.signup_date, e.month_start)
      + ((random() * (e.month_end - GREATEST(e.signup_date, e.month_start)))::INT) AS event_date,
    e.subscription_tier,
    FALSE AS is_activation_stage
  FROM recurring_events e
  WHERE GREATEST(e.signup_date, e.month_start) <= e.month_end

  UNION ALL

  SELECT
    a.user_key,
    a.event_date,
    up.subscription_tier,
    TRUE AS is_activation_stage
  FROM activation_events a
  JOIN dim_user up ON up.user_key = a.user_key
),
event_enriched AS (
  SELECT
    ep.*,
    (ep.event_date
     + (random() * INTERVAL '20 hours')) AS event_ts,  -- spread across the day
    -- Content mix: team spaces heavier on wikis/databases/task boards.
    CASE
      WHEN random() < 0.28 THEN 'cnt_database'
      WHEN random() < 0.52 THEN 'cnt_wiki'
      WHEN random() < 0.72 THEN 'cnt_taskboard'
      WHEN random() < 0.88 THEN 'cnt_page'
      ELSE                     'cnt_template'
    END AS content_id_nat,
    -- Device mix: desktop/web more common for work, mobile for lighter use.
    CASE
      WHEN random() < 0.35 THEN 'dev_desktop'
      WHEN random() < 0.60 THEN 'dev_web_win'
      WHEN random() < 0.75 THEN 'dev_web_mac'
      WHEN random() < 0.88 THEN 'dev_ios'
      ELSE                     'dev_android'
    END AS device_id_nat,
    -- Event mix: creation/collaboration weighted for richer engagement.
    CASE
      WHEN random() < 0.18 THEN 'create'
      WHEN random() < 0.36 THEN 'edit'
      WHEN random() < 0.48 THEN 'comment'
      WHEN random() < 0.60 THEN 'share'
      WHEN random() < 0.72 THEN 'db_query'
      WHEN random() < 0.84 THEN 'template_use'
      WHEN random() < 0.92 THEN 'api_call'
      ELSE                     'view'
    END AS event_type
  FROM event_pool ep
)
INSERT INTO fact_product_usage_engagement (
  time_key,
  user_key,
  workspace_key,
  content_key,
  device_key,
  event_key,
  session_key,
  event_count,
  active_user_flag,
  activation_event_flag,
  feature_usage_flag,
  collaboration_event_flag,
  session_event_count,
  session_duration_sec
)
SELECT
  t.time_key,
  ev.user_key,
  w.workspace_key,
  c.content_key,
  d.device_key,
  e.event_key,
  s.session_key,
  1 AS event_count,
  CASE
    WHEN ev.is_activation_stage THEN 1
    WHEN ((EXTRACT(DAY FROM ev.event_date))::INT % 5) = 0 THEN 1
    ELSE 0
  END AS active_user_flag,
  CASE
    WHEN ev.is_activation_stage THEN 1
    ELSE 0
  END AS activation_event_flag,
  CASE
    WHEN e.event_type IN ('create','edit','db_query','template_use','api_call') THEN 1
    WHEN random() < 0.20 THEN 1 ELSE 0
  END AS feature_usage_flag,
  CASE
    WHEN e.event_type IN ('comment','share') THEN 1
    WHEN c.content_type IN ('wiki','task_board','database') AND random() < 0.65 THEN 1
    ELSE 0
  END AS collaboration_event_flag,
  GREATEST(2, 2 + (random()*12)::INT) AS session_event_count,
  CASE d.platform
    WHEN 'desktop' THEN 2400 + (random()*800)::INT
    WHEN 'web'     THEN 1800 + (random()*600)::INT
    ELSE                900 + (random()*500)::INT
  END AS session_duration_sec
FROM event_enriched ev
JOIN user_profile up ON up.user_key = ev.user_key
JOIN dim_time t      ON t.calendar_date = ev.event_date
JOIN dim_content c   ON c.content_id_nat = ev.content_id_nat
JOIN dim_device d    ON d.device_id_nat = ev.device_id_nat
JOIN dim_event e     ON e.event_type = ev.event_type
CROSS JOIN LATERAL (
  SELECT workspace_key FROM dim_workspace ORDER BY random() LIMIT 1
) w
CROSS JOIN LATERAL (
  SELECT session_key
  FROM dim_session s
  WHERE ev.event_date BETWEEN s.session_start_time::date AND s.session_end_time::date
  ORDER BY random()
  LIMIT 1
) s;
\end{lstlisting}

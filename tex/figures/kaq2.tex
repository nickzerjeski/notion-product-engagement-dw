\def\MonthTickLabels{2024-01,2024-02,2024-03,2024-04,2024-05,2024-06,2024-07,2024-08,2024-09,2024-10,2024-11,2024-12,2025-01,2025-02,2025-03,2025-04,2025-05,2025-06,2025-07,2025-08,2025-09,2025-10,2025-11,2025-12}

\pgfplotstableread[col sep=comma]{../../results/kaq2.csv}\kaqtwodata

\begin{figure}[H]
\centering
\begin{tikzpicture}
\begin{axis}[
    width=\textwidth,
    height=9cm,
    ybar stacked,
    bar width=10pt,
    ymin=0,
    xtick={0,...,23},
    xticklabels={\MonthTickLabels},
    xticklabel style={rotate=45, anchor=east},
    ylabel={Events},
    legend style={at={(0.02,0.98)}, anchor=north west, cells={anchor=west}},
    grid=both,
    major grid style={gray!30},
    minor grid style={gray!15},
]
    \addplot+[fill=blue!50]
        table[
            x expr=\coordindex,
            y=events,
            row predicate/.code={
                \pgfplotstablegetelem{\pgfplotstablerow}{year}\of{\kaqtwodata}
                \edef\yearval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{month}\of{\kaqtwodata}
                \edef\monthval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{content_type}\of{\kaqtwodata}
                \edef\ctype{\pgfplotsretval}
                \ifnum\pdfstrcmp{\yearval}{NULL}=0
                    \pgfplotstableuserowfalse
                \else
                    \ifnum\pdfstrcmp{\monthval}{NULL}=0
                        \pgfplotstableuserowfalse
                    \else
                        \ifnum\pdfstrcmp{\ctype}{wiki}=0
                        \else
                            \pgfplotstableuserowfalse
                        \fi
                    \fi
                \fi
            }
        ] {\kaqtwodata};
    \addlegendentry{Wiki}

    \addplot+[fill=green!55!black]
        table[
            x expr=\coordindex,
            y=events,
            row predicate/.code={
                \pgfplotstablegetelem{\pgfplotstablerow}{year}\of{\kaqtwodata}
                \edef\yearval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{month}\of{\kaqtwodata}
                \edef\monthval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{content_type}\of{\kaqtwodata}
                \edef\ctype{\pgfplotsretval}
                \ifnum\pdfstrcmp{\yearval}{NULL}=0
                    \pgfplotstableuserowfalse
                \else
                    \ifnum\pdfstrcmp{\monthval}{NULL}=0
                        \pgfplotstableuserowfalse
                    \else
                        \ifnum\pdfstrcmp{\ctype}{database}=0
                        \else
                            \pgfplotstableuserowfalse
                        \fi
                    \fi
                \fi
            }
        ] {\kaqtwodata};
    \addlegendentry{Database}

    \addplot+[fill=orange!70]
        table[
            x expr=\coordindex,
            y=events,
            row predicate/.code={
                \pgfplotstablegetelem{\pgfplotstablerow}{year}\of{\kaqtwodata}
                \edef\yearval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{month}\of{\kaqtwodata}
                \edef\monthval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{content_type}\of{\kaqtwodata}
                \edef\ctype{\pgfplotsretval}
                \ifnum\pdfstrcmp{\yearval}{NULL}=0
                    \pgfplotstableuserowfalse
                \else
                    \ifnum\pdfstrcmp{\monthval}{NULL}=0
                        \pgfplotstableuserowfalse
                    \else
                        \ifnum\pdfstrcmp{\ctype}{task_board}=0
                        \else
                            \pgfplotstableuserowfalse
                        \fi
                    \fi
                \fi
            }
        ] {\kaqtwodata};
    \addlegendentry{Task board}

    \addplot+[fill=gray!60]
        table[
            x expr=\coordindex,
            y=events,
            row predicate/.code={
                \pgfplotstablegetelem{\pgfplotstablerow}{year}\of{\kaqtwodata}
                \edef\yearval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{month}\of{\kaqtwodata}
                \edef\monthval{\pgfplotsretval}
                \pgfplotstablegetelem{\pgfplotstablerow}{content_type}\of{\kaqtwodata}
                \edef\ctype{\pgfplotsretval}
                \ifnum\pdfstrcmp{\yearval}{NULL}=0
                    \pgfplotstableuserowfalse
                \else
                    \ifnum\pdfstrcmp{\monthval}{NULL}=0
                        \pgfplotstableuserowfalse
                    \else
                        \ifnum\pdfstrcmp{\ctype}{page}=0
                        \else
                            \pgfplotstableuserowfalse
                        \fi
                    \fi
                \fi
            }
        ] {\kaqtwodata};
    \addlegendentry{Page}
\end{axis}
\end{tikzpicture}
\caption{Monthly events by content type (kaq2).}
\label{fig:kaq2}
\end{figure}
